<div class="progress-tracking-container">
  <div class="page-header">
    <h1>
      <span class="material-icons">trending_up</span>
      تتبع التقدم
    </h1>
    <p>مراقبة وتحديث تقدم الطلاب في الفصول</p>
  </div>

  <div class="card filter-card">ٍ
    <div class="card-body">
      <div class="filter-form-group d-flex gap-2 my-2">
        <div class="form-floating col-md-4">
          <select class="form-select" id="classSelect" aria-label="Select Class" [(ngModel)]="halaqaId"
            (ngModelChange)="onHalaqaChange()">
            <option [value]="0">اختر الفصل</option>
            @for(halaqa of halaqaNamesList; track $index) {
            <option [value]="halaqa.id">{{halaqa.name}}</option>
            }
          </select>
          <label for="classSelect">اسم الفصل</label>
        </div>

        <div class="form-floating col-md-4">
          <input type="date" class="form-control" id="dateSelect" placeholder="اختر التاريخ" [(ngModel)]="date"
            [ngClass]="{'is-invalid': validationErrors.length && (!date )}" />
          <label for="dateSelect">التاريخ</label>
        </div>
        <div class="form-floating col-md-4">
          <select class="form-select" [(ngModel)]="isQuranTracking" (ngModelChange)="onQuranTrackingChange()">
            <option [ngValue]="true">قرآن كريم</option>
            <option [ngValue]="false">علوم اسلامية</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="validationErrors.length > 0" class="alert alert-danger">
    <ul>
      <li *ngFor="let err of validationErrors">{{err}}</li>
    </ul>
  </div>

  <div class="card progress-table-card">
    <div class="card-body">
      <ul class="nav nav-tabs" id="progressTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="memorization-tab" data-bs-toggle="tab" data-bs-target="#memorization"
            type="button" role="tab" aria-controls="memorization" aria-selected="true">
            التفيـــم
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="attendance-notes-tab" data-bs-toggle="tab" data-bs-target="#attendance-notes"
            type="button" role="tab" aria-controls="attendance-notes" aria-selected="false">
            الحضـــور
          </button>
        </li>
      </ul>
      <div class="tab-content" id="progressTabsContent">
        <div class="tab-pane fade show active" id="memorization" role="tabpanel" aria-labelledby="memorization-tab">
          <div class="table-container">
            @if(isQuranTracking) {
            <table class="table progress-table">
              <thead>
                <tr>
                  <th>من سورة</th>
                  <th>من آية</th>
                  <th>إلى سورة</th>
                  <th>إلى آية</th>
                  <th>عدد الأسطر</th>
                  <th>نوع التقدم</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <select class="form-select" [(ngModel)]="fromSurah" (ngModelChange)="onFromSurahChange()" required
                      [ngClass]="{'is-invalid': validationErrors.length && (!fromSurah || fromSurah === 0)}">
                      @for(surah of quranList; track $index) {
                      <option [value]="$index+1">{{surah}}</option>
                      }
                    </select>
                  </td>
                  <td>
                    <select class="form-select" [(ngModel)]="fromAyah" required
                      [ngClass]="{'is-invalid': validationErrors.length && (!fromAyah || fromAyah === 0)}">
                      @for(num of getAyahRange(fromSurah); track num) {
                      <option [value]="num">{{num}}</option>
                      }
                    </select>
                  </td>
                  <td>
                    <select class="form-select" [(ngModel)]="toSurah" (ngModelChange)="onFromSurahChange()" required
                      [ngClass]="{'is-invalid': validationErrors.length && (!toSurah || toSurah === 0)}">
                      @for(surah of quranList; track $index) {
                      <option [value]="$index+1">{{surah}}</option>
                      }
                    </select>
                  </td>
                  <td>
                    <select class="form-select" [(ngModel)]="toAyah" required
                      [ngClass]="{'is-invalid': validationErrors.length && (!toAyah || toAyah === 0)}">
                      @for(num of getAyahRange(toSurah); track num) {
                      <option [value]="num">{{num}}</option>
                      }
                    </select>
                  </td>
                  <td>
                    <input type="number" class="form-control" [(ngModel)]="numberOfLines" min="1" required
                      [ngClass]="{'is-invalid': validationErrors.length && (!numberOfLines || numberOfLines < 1)}" />
                  </td>
                  <td>
                    <select class="form-select" [(ngModel)]="type">
                      <option value="0">تحفــيظ</option>
                      <option value="1">مــراجعــة</option>
                    </select>
                  </td>
                </tr>
              </tbody>
            </table>

            }
            @else {
            <table class="table progress-table">
              <thead>
                <tr>
                  <th>من صفحة</th>
                  <th>إلى صفحة</th>
                  <th>اسم الدرس</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <input type="number" class="form-control" [(ngModel)]="fromPage" min="1" required
                      [ngClass]="{'is-invalid': validationErrors.length && (!fromPage || fromPage < 1)}" />
                  </td>
                  <td>
                    <input type="number" class="form-control" [(ngModel)]="toPage" min="1" required
                      [ngClass]="{'is-invalid': validationErrors.length && (!toPage || toPage < 1)}" />
                  </td>
                  <td>
                    <input type="text" class="form-control" [(ngModel)]="lessonName" required
                      [ngClass]="{'is-invalid': validationErrors.length && (!lessonName || lessonName.trim() === '')}" />
                  </td>
                </tr>
              </tbody>
            </table>
            }
            <table class="table progress-table">
              <thead>
                <tr>
                  <th>اسم الطالب</th>
                  <th>التقييم</th>
                  <th>الملاحظات</th>
                  <th>الحالة</th>

                </tr>
              </thead>
              <tbody>
                @for(student of students; track $index) {
                <tr>
                  <td>{{student.name}}</td>
                  <td class="evaluation-select">
                    <select class="form-select" [(ngModel)]="evaluation[$index]" required>
                      <option value="ممتاز">ممتاز</option>
                      <option value="جيد" selected>جيد</option>
                      <option value="مقبول">مقبول</option>
                      <option value="ضعيف">ضعيف</option>
                    </select>
                  </td>
                  <td>
                    <input type="text" class="form-control" [(ngModel)]="notes[$index]" />
                  </td>
                  <td>
                    <input type="text" class="form-control" [(ngModel)]="status[$index]" required />
                  </td>
                </tr>
                }
              </tbody>
            </table>
            <button type="button" class="btn btn-primary" (click)="onProgressSubmit()"
              [disabled]="students.length == 0">
              <span class="material-icons">save</span>
              حفظ التقدم
            </button>
          </div>
        </div>

        <div class="tab-pane fade" id="attendance-notes" role="tabpanel" aria-labelledby="attendance-notes-tab">
          <div class="table-container">
            <table class="table progress-table">
              <thead>
                <tr>
                  <th>اسم الطالب</th>
                  <th>الحضور</th>
                  <th>الملاحظات</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>أحمد علي</td>
                  <td class="attendance-toggle">
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-outline-success btn-attendance-present active">
                        حاضر
                      </button>
                      <button type="button" class="btn btn-outline-danger btn-attendance-absent">
                        غائب
                      </button>
                      <button type="button" class="btn btn-outline-warning btn-attendance-late">
                        متأخر
                      </button>
                      <button type="button" class="btn btn-outline-info btn-attendance-excused">
                        بإذن
                      </button>
                    </div>
                  </td>
                  <td>
                    <input type="text" class="form-control" placeholder="أضف ملاحظات..." />
                  </td>
                </tr>
                <tr>
                  <td>فاطمة الزهراء</td>
                  <td class="attendance-toggle">
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-outline-success btn-attendance-present">
                        حاضر
                      </button>
                      <button type="button" class="btn btn-outline-danger btn-attendance-absent active">
                        غائب
                      </button>
                      <button type="button" class="btn btn-outline-warning btn-attendance-late">
                        متأخر
                      </button>
                      <button type="button" class="btn btn-outline-info btn-attendance-excused">
                        بإذن
                      </button>
                    </div>
                  </td>
                  <td>
                    <input type="text" class="form-control" placeholder="أضف ملاحظات..." value="إجازة مرضية" />
                  </td>
                </tr>
                <tr>
                  <td>يوسف عمر</td>
                  <td class="attendance-toggle">
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-outline-success btn-attendance-present">
                        حاضر
                      </button>
                      <button type="button" class="btn btn-outline-danger btn-attendance-absent">
                        غائب
                      </button>
                      <button type="button" class="btn btn-outline-warning btn-attendance-late active">
                        متأخر
                      </button>
                      <button type="button" class="btn btn-outline-info btn-attendance-excused">
                        بإذن
                      </button>
                    </div>
                  </td>
                  <td>
                    <input type="text" class="form-control" placeholder="أضف ملاحظات..." />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="action-buttons mt-4">
        <button type="button" class="btn btn-secondary">
          <span class="material-icons">clear_all</span>
          مسح التقدم
        </button>
        <button type="button" class="btn btn-primary">
          <span class="material-icons">save</span>
          حفظ التقدم
        </button>
      </div>
    </div>
  </div>
</div>
